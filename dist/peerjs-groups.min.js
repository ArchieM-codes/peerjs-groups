//Minified version of the main file. Copyright(C) 2025 volcar144

!function(e){"use strict";if("undefined"==typeof Peer)throw new Error("Peer.js must be included before peer-group.js");function t(){this._events={}}t.prototype.on=function(e,t){if("function"==typeof t)return(this._events[e]||(this._events[e]=[])).push(t),this},t.prototype.off=function(e,t){return this._events[e]?(this._events[e]=this._events[e].filter((e=>e!==t)),this):this},t.prototype.emit=function(e,...t){(this._events[e]||[]).slice().forEach((e=>{try{e.apply(this,t)}catch(e){console.error("Event handler error",e)}}))};var n={Host:function(e,n){if("string"!=typeof e||!e)throw new Error("Host: groupId must be a non-empty string");t.call(this),this.groupId=e,this.peer=new Peer(e,n||{}),this._members={},this._banned=new Set,this._queues=new WeakMap,this.peer.on("open",(e=>this.emit("open",e))),this.peer.on("error",(e=>this.emit("error",e))),this.peer.on("connection",(e=>this._handleConn(e)))}};n.Host.prototype=Object.create(t.prototype),n.Host.prototype.constructor=n.Host,n.Host.prototype._handleConn=function(e){var t=this,n=e.peer;this._banned.has(n)?e.on("open",(()=>{e.send({type:"joinRejected",reason:"banned"}),e.close()})):(this._queues.set(e,[]),e.on("data",(t=>this._onData(e,t))),e.on("open",(()=>this._flush(e))),e.on("close",(()=>{t._members[n]&&(delete t._members[n],t.emit("memberLeft",n),t._broadcastMemberList()),t._queues.delete(e)})))},n.Host.prototype._onData=function(e,t){if(t&&"string"==typeof t.type){var n=e.peer;switch(t.type){case"joinRequest":var o="string"==typeof t.nickname&&t.nickname.trim()?t.nickname.trim():n;this.emit("joinRequest",n,o,(()=>this._accept(e,o)),(t=>this._reject(e,t)));break;case"message":if(!this._members[n])return;this.emit("message",t.payload,n,this._members[n].nickname),this._broadcast({type:"message",payload:t.payload,fromId:n,fromNick:this._members[n].nickname},e);break;case"nicknameChange":if(!this._members[n])return;var i=this._members[n].nickname,s="string"==typeof t.nickname&&t.nickname.trim()?t.nickname.trim():i;this._members[n].nickname=s,this.emit("nicknameChanged",n,i,s),this._broadcastMemberList()}}},n.Host.prototype._accept=function(e,t){if(e.open){var n=e.peer;this._members[n]={conn:e,nickname:t},e.send({type:"joinAccepted",nickname:this._ownNick||this.groupId}),this.emit("memberJoined",n,t),this._broadcastMemberList()}},n.Host.prototype._reject=function(e,t){t=t||"rejected",e.open&&e.send({type:"joinRejected",reason:t}),e.close()},n.Host.prototype._broadcast=function(e,t){Object.values(this._members).forEach((n=>{n.conn!==t&&this._send(n.conn,e)}))},n.Host.prototype._send=function(e,t){var n=this._queues.get(e);e.open?e.send(t):n&&n.push(t)},n.Host.prototype._flush=function(e){for(var t=this._queues.get(e);t&&t.length;)e.send(t.shift())},n.Host.prototype._broadcastMemberList=function(){var e=Object.entries(this._members).map((([e,t])=>({id:e,nickname:t.nickname})));this._broadcast({type:"memberList",members:e})},n.Host.prototype.kick=function(e,t){var n=this._members[e];n&&(this._send(n.conn,{type:"kicked",reason:t||"kicked"}),n.conn.close(),delete this._members[e],this.emit("memberLeft",e),this._broadcastMemberList())},n.Host.prototype.ban=function(e){this._banned.add(e),this.kick(e,"banned")},n.Host.prototype.sendTo=function(e,t){var n=this._members[e];if(!n)throw new Error("sendTo: no such member");this._send(n.conn,{type:"message",payload:t,fromId:this.groupId,fromNick:this._ownNick||this.groupId})},n.Host.prototype.broadcast=function(e){this._broadcast({type:"message",payload:e,fromId:this.groupId,fromNick:this._ownNick||this.groupId})},n.Host.prototype.setHostNickname=function(e){if("string"!=typeof e||!e.trim())throw new Error("Invalid nickname");this._ownNick=e.trim()},n.Host.prototype.getMembers=function(){return Object.entries(this._members).map((([e,t])=>({id:e,nickname:t.nickname})))},n.Host.prototype.close=function(){this.peer.destroy(),Object.keys(this._members).forEach((e=>this.kick(e,"shutdown"))),this._banned.clear()},n.Client=function(e){if(!e||"string"!=typeof e.clientId||!e.groupId)throw new Error("Client: must supply clientId and groupId");t.call(this),this.clientId=e.clientId,this.groupId=e.groupId,this.nickname=(e.nickname||e.clientId).trim(),this.peer=new Peer(this.clientId,e.options||{}),this.conn=null,this._queue=[],this._joined=!1;var n=this;this.peer.on("open",(e=>n.emit("open",e))),this.peer.on("error",(e=>n.emit("error",e)))},n.Client.prototype=Object.create(t.prototype),n.Client.prototype.constructor=n.Client,n.Client.prototype.join=function(){var e=this;return new Promise((function(t,n){if(e._joined)return n(new Error("Already joined"));e.conn=e.peer.connect(e.groupId,{reliable:!0}),e.conn.on("open",(()=>e._flush())),e.conn.on("data",(o=>e._onData(o,t,n))),e.conn.on("close",(()=>{e._joined=!1,e.emit("disconnected")})),e._send({type:"joinRequest",nickname:e.nickname})}))},n.Client.prototype._onData=function(e,t,n){switch(e.type){case"joinAccepted":this._joined=!0,this.emit("joined"),t();break;case"joinRejected":n(new Error(e.reason)),this.conn.close();break;case"message":this.emit("message",e.payload,e.fromId,e.fromNick);break;case"memberList":this.emit("memberList",e.members);break;case"kicked":this.emit("kicked",e.reason),this.conn.close()}},n.Client.prototype.send=function(e){if(!this._joined)throw new Error("Not joined yet");this._send({type:"message",payload:e})},n.Client.prototype.sendToHost=function(e){this.send(e)},n.Client.prototype.changeNickname=function(e){if("string"!=typeof e||!e.trim())throw new Error("Invalid nickname");this.nickname=e.trim(),this._send({type:"nicknameChange",nickname:this.nickname})},n.Client.prototype._send=function(e){this.conn&&this.conn.open?this.conn.send(e):this._queue.push(e)},n.Client.prototype._flush=function(){for(;this._queue.length;)this.conn.send(this._queue.shift())},n.Client.prototype.leave=function(){this.conn&&this.conn.close(),this._joined=!1},n.Client.prototype.close=function(){this.leave(),this.peer.destroy()},n.Bot=function(e){n.Client.call(this,e),this._commands={},this.on("message",((e,t,n)=>{if("string"==typeof e&&e.startsWith("!")){var o=e.slice(1).trim().split(/\s+/),i=o.shift().toLowerCase(),s=this._commands[i];if(s)try{s(o,t,n,(e=>this.send(e)))}catch(e){console.error("Bot handler error",e)}}}))},n.Bot.prototype=Object.create(n.Client.prototype),n.Bot.prototype.constructor=n.Bot,n.Bot.prototype.registerCommand=function(e,t){if("string"!=typeof e||"function"!=typeof t)throw new Error("Invalid command registration");this._commands[e.toLowerCase()]=t},e.PeerGroups=n}(window);
