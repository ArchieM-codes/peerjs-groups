//A minified version of the main code.   Copyright(C) 2025 Volcar144

function escapeHTML(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}const PeerGroupEvents=Object.freeze({OPEN:"open",ERROR:"error",CONNECT:"connect",DISCONNECT:"disconnect",JOIN_REQUEST:"joinRequest",JOIN_APPROVED:"joinApproved",JOIN_REJECTED:"joinRejected",MEMBER_JOINED:"memberJoined",MEMBER_LEFT:"memberLeft",MEMBER_LIST:"memberList",MESSAGE:"message",PRIVATE_MESSAGE:"privateMessage",NICKNAME_CHANGED:"nicknameChanged",KICKED:"kicked",BANNED:"banned",UNBANNED:"unbanned",SHUTDOWN:"shutdown",MESSAGE_CENSORED:"messageCensored"});class EventListener{constructor(e,t,s=0){this.eventType=e,this.callback=t,this.priority=s,this.active=!0}}class AdvancedEmitter{constructor(){this._listeners=new Map}addListener(e){if(!e.active)return this;const t=this._listeners.get(e.eventType)||[];return t.push(e),t.sort(((e,t)=>t.priority-e.priority)),this._listeners.set(e.eventType,t),this}removeListener(e,t){if(!this._listeners.has(e))return this;if(t){const s=this._listeners.get(e).filter((e=>e.callback!==t));this._listeners.set(e,s)}else this._listeners.delete(e);return this}emit(e,...t){const s=this._listeners.get(e)||[];for(const n of s)if(n.active)try{n.callback(...t)}catch(t){console.error(`Error in listener for ${e}:`,t)}}}class PeerGroupsBase extends AdvancedEmitter{constructor(){super()}}class Host extends PeerGroupsBase{constructor(e,t={},s={}){super(),this.groupId=e,this.peer=new Peer(e,t),this._members=new Map,this._banned=new Set,this.moderationOptions=s,this.bannedWords=new Set(s.bannedWords||[]),this.peer.on("open",(e=>this.emit(PeerGroupEvents.OPEN,e))),this.peer.on("error",(e=>this.emit(PeerGroupEvents.ERROR,e))),this.peer.on("connection",(e=>this._onConnection(e)))}_onConnection(e){const t=e.peer;e.on("open",(()=>{this.emit(PeerGroupEvents.CONNECT,t),e.on("data",(t=>this._onData(e,t))),e.on("close",(()=>this._onPeerClose(t)))}))}_onData(e,t){const s=e.peer,n=t&&t.type?t:{};switch(n.type){case"joinRequest":if(this._banned.has(s))return this._send(e,{type:"joinRejected",reason:"banned"}),void this.emit(PeerGroupEvents.BANNED,s);this.emit(PeerGroupEvents.JOIN_REQUEST,s,n.nickname,(()=>this._approve(e,n.nickname)),(t=>this._reject(e,t)));break;case"message":{let e=escapeHTML(n.payload);if(this.bannedWords.size>0){const t=e;e=this._censorMessage(e),e!==t&&this.emit(PeerGroupEvents.MESSAGE_CENSORED,t,e,s)}this.emit(PeerGroupEvents.MESSAGE,e,s,this._members.get(s)?.nickname),this._broadcast({type:"message",payload:e},s)}break;case"privateMessage":{let e=escapeHTML(n.payload);if(this.bannedWords.size>0){const t=e;e=this._censorMessage(e),e!==t&&this.emit(PeerGroupEvents.MESSAGE_CENSORED,t,e,s)}const t=n.to;this.emit(PeerGroupEvents.PRIVATE_MESSAGE,e,s,t),this._sendTo(t,{type:"privateMessage",payload:e,from:s})}break;case"nicknameChange":{const e=this._members.get(s)?.nickname,t=escapeHTML(n.newNickname);this._members.get(s).nickname=t,this.emit(PeerGroupEvents.NICKNAME_CHANGED,s,e,t),this._broadcast({type:"nicknameChange",newNickname:t})}break;default:this.emit(PeerGroupEvents.ERROR,new Error(`Unknown data type: ${n.type}`))}}_approve(e,t){const s=e.peer,n=escapeHTML(t);this._members.set(s,{conn:e,nickname:n}),this._send(e,{type:"joinApproved",nickname:n}),this.emit(PeerGroupEvents.JOIN_APPROVED,s,n),this.emit(PeerGroupEvents.MEMBER_JOINED,s,n),this._updateMemberList()}_reject(e,t){this._send(e,{type:"joinRejected",reason:t}),e.close(),this.emit(PeerGroupEvents.JOIN_REJECTED,e.peer,t)}_onPeerClose(e){const t=this._members.get(e);t&&(this._members.delete(e),this.emit(PeerGroupEvents.DISCONNECT,e),this.emit(PeerGroupEvents.MEMBER_LEFT,e,t.nickname),this._updateMemberList())}_broadcast(e,t){for(const[s,{conn:n}]of this._members)s!==t&&this._send(n,e)}_sendTo(e,t){const s=this._members.get(e);s&&this._send(s.conn,t)}_send(e,t){try{e.send(t)}catch(e){this.emit(PeerGroupEvents.ERROR,e)}}_updateMemberList(){const e=Array.from(this._members.entries()).map((([e,{nickname:t}])=>({id:e,nickname:t})));this.emit(PeerGroupEvents.MEMBER_LIST,e),this._broadcast({type:"memberList",list:e})}send(e){let t=escapeHTML(e);if(this.bannedWords.size>0){const e=t;t=this._censorMessage(t),t!==e&&this.emit(PeerGroupEvents.MESSAGE_CENSORED,e,t,this.peer.id)}this._broadcast({type:"message",payload:t}),this.emit(PeerGroupEvents.MESSAGE,t,this.peer.id,"(host)")}sendPrivate(e,t){let s=escapeHTML(t);if(this.bannedWords.size>0){const e=s;s=this._censorMessage(s),s!==e&&this.emit(PeerGroupEvents.MESSAGE_CENSORED,e,s,this.peer.id)}this._sendTo(e,{type:"privateMessage",payload:s,from:this.peer.id}),this.emit(PeerGroupEvents.PRIVATE_MESSAGE,s,this.peer.id,e)}kick(e,t="kicked"){const s=this._members.get(e);s&&(this._send(s.conn,{type:"kicked",reason:t}),s.conn.close(),this.emit(PeerGroupEvents.KICKED,e,t))}ban(e){this._banned.add(e),this.kick(e,"banned"),this.emit(PeerGroupEvents.BANNED,e)}unban(e){this._banned.delete(e),this.emit(PeerGroupEvents.UNBANNED,e)}addBannedWord(e){this.bannedWords.add(e)}removeBannedWord(e){this.bannedWords.delete(e)}_censorMessage(e){let t=e;for(const e of this.bannedWords){const s=new RegExp(`\\b${e}\\b`,"gi");t=t.replace(s,"****")}return t}close(){for(const{conn:e}of this._members.values())e.close();this.peer.destroy(),this.emit(PeerGroupEvents.SHUTDOWN)}}class Client extends PeerGroupsBase{constructor(e,t,s={}){super(),this.clientId=e,this.groupId=t,this.peer=new Peer(e,s),this.conn=null,this.nickname=null,this.peer.on("open",(e=>this.emit(PeerGroupEvents.OPEN,e))),this.peer.on("error",(e=>this.emit(PeerGroupEvents.ERROR,e)))}join(e,t){this.nickname=escapeHTML(t),this.conn=this.peer.connect(e),this.conn.on("open",(()=>{this.emit(PeerGroupEvents.CONNECT,e),this._send({type:"joinRequest",nickname:this.nickname})})),this.conn.on("data",(e=>this._onData(e))),this.conn.on("close",(()=>this.emit(PeerGroupEvents.DISCONNECT,e)))}_onData(e){const t=e&&e.type?e:{};switch(t.type){case"joinApproved":this.emit(PeerGroupEvents.JOIN_APPROVED,this.peer.id,t.nickname);break;case"joinRejected":this.emit(PeerGroupEvents.JOIN_REJECTED,t.reason);break;case"message":this.emit(PeerGroupEvents.MESSAGE,t.payload,t.from||this.conn.peer);break;case"privateMessage":this.emit(PeerGroupEvents.PRIVATE_MESSAGE,t.payload,t.from||this.conn.peer);break;case"memberList":this.emit(PeerGroupEvents.MEMBER_LIST,t.list);break;case"kicked":this.emit(PeerGroupEvents.KICKED,t.reason),this.conn.close();break;case"shutdown":this.emit(PeerGroupEvents.SHUTDOWN),this.conn.close();break;default:this.emit(PeerGroupEvents.ERROR,new Error(`Unknown data: ${t.type}`))}}send(e){const t=escapeHTML(e);this._send({type:"message",payload:t})}sendPrivate(e,t){const s=escapeHTML(t);this._send({type:"privateMessage",payload:s,to:e})}changeNickname(e){const t=escapeHTML(e);this.nickname=t,this._send({type:"nicknameChange",newNickname:t})}disconnect(){this.conn&&this.conn.close()}_send(e){try{this.conn.send(e)}catch(e){this.emit(PeerGroupEvents.ERROR,e)}}}class Bot extends Client{constructor(e,t,s={}){super(e,t,s),this._commands=new Map,this.on(PeerGroupEvents.MESSAGE,((e,t)=>this._handleMessage(e,t)))}registerCommand(e,t){this._commands.set(e,t)}_handleMessage(e,t){if(!e.startsWith("/"))return;const s=e.slice(1).split(/\s+/),n=s.shift(),i=this._commands.get(n);if(i)try{i(s,t)}catch(e){this.emit(PeerGroupEvents.ERROR,e)}}}class PeerAdmin extends PeerGroupsBase{constructor(e,t,s,n={}){super(),this.adminId=e,this.groupId=t,this.secret=s,this.peer=new Peer(e,n),this.conn=null,this.authenticated=!1,this.peer.on("open",(e=>this.emit(PeerGroupEvents.OPEN,e))),this.peer.on("error",(e=>this.emit(PeerGroupEvents.ERROR,e)))}connect(e){this.conn=this.peer.connect(e),this.conn.on("open",(()=>{this.emit(PeerGroupEvents.CONNECT,e),this._send({type:"adminAuth",secret:this.secret})})),this.conn.on("data",(e=>this._onData(e))),this.conn.on("close",(()=>{this.authenticated=!1,this.emit(PeerGroupEvents.DISCONNECT,e)}))}_onData(e){const t=e&&e.type?e:{};switch(t.type){case"adminAuthSuccess":this.authenticated=!0,this.emit("adminAuthSuccess");break;case"adminAuthFailed":this.authenticated=!1,this.emit("adminAuthFailed",t.reason),this.conn.close();break;case"memberList":this.emit(PeerGroupEvents.MEMBER_LIST,t.list);break;default:this.emit(PeerGroupEvents.ERROR,new Error(`Unknown data type: ${t.type}`))}}kickClient(e,t){this.authenticated?this._send({type:"adminKickClient",targetClientId:e,reason:t}):this.emit(PeerGroupEvents.ERROR,new Error("Admin not authenticated"))}banClient(e){this.authenticated?this._send({type:"adminBanClient",targetClientId:e}):this.emit(PeerGroupEvents.ERROR,new Error("Admin not authenticated"))}unbanClient(e){this.authenticated?this._send({type:"adminUnbanClient",targetClientId:e}):this.emit(PeerGroupEvents.ERROR,new Error("Admin not authenticated"))}addBannedWord(e){this.authenticated?this._send({type:"adminAddBannedWord",word:e}):this.emit(PeerGroupEvents.ERROR,new Error("Admin not authenticated"))}removeBannedWord(e){this.authenticated?this._send({type:"adminRemoveBannedWord",word:e}):this.emit(PeerGroupEvents.ERROR,new Error("Admin not authenticated"))}shutdownGroup(){this.authenticated?this._send({type:"adminShutdownGroup"}):this.emit(PeerGroupEvents.ERROR,new Error("Admin not authenticated"))}disconnect(){this.conn&&this.conn.close()}_send(e){try{this.conn.send(e)}catch(e){this.emit(PeerGroupEvents.ERROR,e)}}}Host.prototype._onData=function(e,t){const s=e.peer,n=t&&t.type?t:{};switch(n.type){case"adminAuth":n.secret===this.adminSecret?(this._send(e,{type:"adminAuthSuccess"}),this.emit("adminAuthenticated",s)):(this._send(e,{type:"adminAuthFailed",reason:"Invalid secret"}),e.close(),this.emit("adminAuthenticationFailed",s));break;case"adminKickClient":this.kick(n.targetClientId,n.reason||"Kicked by admin");break;case"adminBanClient":this.ban(n.targetClientId);break;case"adminUnbanClient":this.unban(n.targetClientId);break;case"adminAddBannedWord":this.addBannedWord(n.word);break;case"adminRemoveBannedWord":this.removeBannedWord(n.word);break;case"adminShutdownGroup":this.close();break;default:PeerGroupsBase.prototype._onData.call(this,e,t)}},Host.prototype.setupAdmin=function(e){return this.adminSecret=e,this},"undefined"!=typeof module&&module.exports&&(module.exports={escapeHTML:escapeHTML,PeerGroupEvents:PeerGroupEvents,EventListener:EventListener,AdvancedEmitter:AdvancedEmitter,Host:Host,Client:Client,Bot:Bot,PeerAdmin:PeerAdmin});
